<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Kalkulator Bolusa - Aleksander</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 13px; opacity: 0.9; }
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            padding: 14px 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 80px;
        }
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f0f2ff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2 { color: #667eea; margin-bottom: 16px; font-size: 20px; }
        
        /* CALCULATOR STYLES */
        .section-box {
            background: #f8f9fb;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .section-box h3 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 8px;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }
        
        .product-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .product-info { flex: 1; }
        .product-carbs {
            color: #667eea;
            font-weight: 700;
            margin: 0 10px;
        }
        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .result-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            display: none;
        }
        .result-box h3 { font-size: 14px; margin-bottom: 12px; }
        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        /* GUIDE STYLES */
        .guide-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 14px;
            overflow: hidden;
        }
        .guide-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 16px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .guide-section.expanded .guide-content { max-height: 4000px; }
        .guide-section.expanded .guide-arrow { transform: rotate(180deg); }
        .guide-body {
            padding: 16px;
            font-size: 13px;
            line-height: 1.7;
        }
        .decision-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 12px;
        }
        .warning-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 12px;
        }
        .danger-box {
            background: #ffebee;
            border-left: 4px solid #dc3545;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #c41c3b;
        }
        .contact-box {
            background: #e3f2fd;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 12px;
        }
        .contact-box strong {
            display: block;
            margin-bottom: 6px;
            color: #667eea;
            font-weight: 700;
        }
        ul { margin-left: 18px; font-size: 12px; }
        li { margin: 6px 0; line-height: 1.6; }
        strong { color: #667eea; font-weight: 700; }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 18px; }
            .tab-btn { font-size: 11px; padding: 10px 6px; }
            .container { padding: 10px; }
            .content { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üíâ Kalkulator Bolusa - Aleksander</h1>
        <p>Cukrzyca Typ 1 | Urodzony: 11.03.2025</p>
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-tab="calculator">Kalkulator</button>
        <button class="tab-btn" data-tab="products">Produkty</button>
        <button class="tab-btn" data-tab="scanner">Skaner</button>
        <button class="tab-btn" data-tab="guide">üìñ Poradnik</button>
    </div>

    <div class="container">
        <div class="content">
            <!-- CALCULATOR TAB -->
            <div class="tab-pane active" id="calculator">
                <h2>‚öôÔ∏è Kalkulator Bolusa</h2>
                
                <div class="section-box">
                    <h3>Parametry Insuliny</h3>
                    <div class="form-group">
                        <label class="form-label">Glikemia docelowa (mg/dl)</label>
                        <input type="number" id="target-glucose" value="100" step="5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ICR - Wska≈∫nik wƒôglowodan√≥w (g/j.i.)</label>
                        <input type="number" id="icr" value="12" step="0.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ISF - Wra≈ºliwo≈õƒá na insulinƒô (mg/dl/j.i.)</label>
                        <input type="number" id="isf" value="50" step="5">
                    </div>
                </div>

                <div class="section-box">
                    <h3>Pomiar Glikemii</h3>
                    <div class="form-group">
                        <label class="form-label">Obecna glikemia (mg/dl)</label>
                        <input type="number" id="glucose-level" placeholder="Zmierz teraz" step="1">
                    </div>
                </div>

                <div class="section-box">
                    <h3>Wƒôglowodany</h3>
                    <div class="form-group">
                        <label class="form-label">Wƒôglowodany z produkt√≥w (automatycznie)</label>
                        <input type="text" id="products-carbs" value="0 g" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dodatkowe wƒôglowodany rƒôcznie (g)</label>
                        <input type="number" id="manual-carbs" value="0" step="0.5">
                    </div>
                    <button id="add-product-btn">+ Dodaj produkt z bazy</button>
                </div>

                <div id="selected-products">
                    <div style="text-align: center; color: #999; padding: 20px;">Brak wybranych produkt√≥w</div>
                </div>

                <button id="calculate-bolus" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-top: 16px;">üßÆ Oblicz Bolus</button>

                <div id="bolus-result" class="result-box">
                    <h3>Wynik Obliczenia</h3>
                    <div class="result-row">
                        <span>Bolus posi≈Çkowy:</span>
                        <span id="meal-bolus">0</span>
                    </div>
                    <div class="result-row">
                        <span>Bolus korygujƒÖcy:</span>
                        <span id="correction-bolus">0</span>
                    </div>
                    <div class="result-row" style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; font-weight: 700;">
                        <span>Razem:</span>
                        <span id="total-bolus">0</span>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; opacity: 0.9;">
                        Wƒôglowodany: <span id="total-carbs">0</span>g
                    </div>
                    <button id="confirm-bolus" style="background: #28a745; margin-top: 12px;">‚úì Zapisz do historii</button>
                    <button id="cancel-bolus" style="background: #6c757d; margin-top: 8px;">‚úï Anuluj</button>
                </div>

                <div style="margin-top: 24px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">Historia Bolus√≥w</h3>
                    <div id="bolus-history" style="font-size: 12px;">
                        <div style="text-align: center; color: #999; padding: 20px;">Brak historii</div>
                    </div>
                </div>
            </div>

            <!-- PRODUCTS TAB -->
            <div class="tab-pane" id="products">
                <h2>üì¶ Baza Produkt√≥w</h2>
                
                <div class="section-box">
                    <h3>Wyszukiwanie i Filtrowanie</h3>
                    <div class="form-group">
                        <input type="text" id="search-products" placeholder="Szukaj produktu...">
                    </div>
                    <div class="form-group">
                        <select id="filter-category">
                            <option value="">Wszystkie kategorie</option>
                        </select>
                    </div>
                    <button onclick="addNewProduct()">+ Dodaj nowy produkt</button>
                </div>

                <div id="products-list" style="font-size: 12px;">
                    <div style="text-align: center; color: #999; padding: 20px;">≈Åadowanie produkt√≥w...</div>
                </div>
            </div>

            <!-- SCANNER TAB -->
            <div class="tab-pane" id="scanner">
                <h2>üì∑ Skaner Kod√≥w</h2>
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>Funkcja skanera wymaga dostƒôpu do kamery.</p>
                    <p style="font-size: 12px; margin-top: 12px;">Mo≈ºesz rƒôcznie dodaƒá produkty w sekcji Produkty.</p>
                </div>
            </div>

            <!-- GUIDE TAB -->
            <div class="tab-pane" id="guide">
                <h2>üìñ Poradnik Cukrzycy Typu 1 - Aleksander</h2>

                <!-- KONTAKT -->
                <div class="guide-section expanded">
                    <div class="guide-header">
                        <span>üìû Kontakt Z Zespo≈Çem Medycznym</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <div class="contact-box">
                                <strong>üö® POGOTOWIE RATUNKOWE: 999 lub 112</strong>
                                <small><strong>Dzwo≈Ñ NATYCHMIAST je≈õli:</strong></small>
                                <ul style="margin-top: 6px;">
                                    <li>Aleksander jest nieprzytomny</li>
                                    <li>Ma drgawki</li>
                                    <li>Ciƒô≈ºki oddech (Kussmaula)</li>
                                    <li>Zapach acetonu z ust</li>
                                    <li>Nasilone wymioty ponad 2h</li>
                                    <li>Glikemia &gt;250 mg/dl + b√≥l brzucha</li>
                                </ul>
                            </div>
                            <div class="contact-box">
                                <strong>üë®‚Äç‚öïÔ∏è Diabetolog - Nr: ___________________</strong>
                            </div>
                            <div class="contact-box">
                                <strong>üè• Szpital - Nr: ___________________</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SZYBKA ≈öCIƒÑGA -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>‚ö° Szybka ≈öciƒÖga</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <strong>Poziomy Glukozy (mg/dl):</strong>
                            <ul style="margin-top: 8px;">
                                <li><strong>&lt;55:</strong> üî¥ CIƒò≈ªKA - WEZWIJ 999!</li>
                                <li><strong>55-70:</strong> üü† Niska - Szybkie WW</li>
                                <li><strong>70-150:</strong> üü¢ NORMA</li>
                                <li><strong>150-250:</strong> üü° Wysoka</li>
                                <li><strong>&gt;250:</strong> üî¥ Powa≈ºna - Mierz ketony!</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- NISKA GLUKOZA -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>üî¥ Niska Glukoza (&lt;70 mg/dl)</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <div class="decision-box">
                                <strong>Procedura:</strong>
                                <ul>
                                    <li>1Ô∏è‚É£ Zmierz PONOWNIE (mogƒÖ byƒá b≈Çƒôdy)</li>
                                    <li>2Ô∏è‚É£ Podaj 4-5g szybkich WW (sok, cukier)</li>
                                    <li>3Ô∏è‚É£ Czekaj 15 minut</li>
                                    <li>4Ô∏è‚É£ Zmierz ponownie</li>
                                    <li>5Ô∏è‚É£ Je≈õli &lt;70: Powt√≥rz kroki 2-4</li>
                                </ul>
                            </div>
                            <div class="danger-box">
                                üö® Je≈õli nieprzytomny: WEZWIJ 999, podaj glukagon, pozycja boczna!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WYSOKA GLUKOZA -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>üü° Wysoka Glukoza (&gt;150 mg/dl)</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <div class="decision-box">
                                <strong>Procedura:</strong>
                                <ul>
                                    <li>1Ô∏è‚É£ Zmierz ketony</li>
                                    <li>2Ô∏è‚É£ Brak keton√≥w: podaj insulinƒô + woda</li>
                                    <li>3Ô∏è‚É£ ≈ölady keton√≥w: zwiƒôksz insulinƒô o 10%</li>
                                    <li>4Ô∏è‚É£ Wysokie ketony: zwiƒôksz o 30% + wezwij lekarza</li>
                                </ul>
                            </div>
                            <div class="danger-box">
                                üö® Glikemia &gt;250 mg/dl + ketony &gt;0.5 = PODEJRZENIE DKA!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INFEKCJA -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>ü§í Infekcja / Choroba</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <div class="danger-box">
                                üö® ZAWSZE INSULINA - nawet je≈õli nie je!
                            </div>
                            <ul>
                                <li>Mierz glukozƒô co 2-4h</li>
                                <li>Glukoza zwykle RO≈öNIE</li>
                                <li>Zwiƒôksz insulinƒô o 10-50%</li>
                                <li>Monitoruj ketony!</li>
                                <li>Hydratacja - du≈ºo wody</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- AWARIA POMPY -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>üîß Awaria Pompy</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <div class="danger-box">
                                üö® Pompa ca≈Çkowicie zepsuta = PRZEJD≈π NA PENY!
                            </div>
                            <ul>
                                <li>Zwiƒôksz insulinƒô o 20-30%</li>
                                <li>Mierz glukozƒô co 2-3h</li>
                                <li>Monitoruj ketony (DKA!)</li>
                                <li>Skontaktuj siƒô z diabetologiem</li>
                                <li>Zawsze miej zapasowƒÖ insulinƒô w lod√≥wce</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- DOBRE PRAKTYKI -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>‚úÖ Dobre Praktyki</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <ul>
                                <li><strong>1. Insulina zawsze</strong> - nigdy nie przerywaj!</li>
                                <li><strong>2. Mierz glukozƒô regularnie</strong> - przed posi≈Çkami, 2h po, przed snem</li>
                                <li><strong>3. Obserwuj zmiany</strong> - zapotrzebowanie ro≈õnie co miesiƒÖc</li>
                                <li><strong>4. Dieta = obliczanie WW</strong> - brak zakaz√≥w!</li>
                                <li><strong>5. Edukacja rodziny</strong> - babcia, dziadek, opiekunowie</li>
                                <li><strong>6. Psychika dziecka</strong> - cukrzyca to nie kara!</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- OBLICZENIA -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>üßÆ Obliczanie Parametr√≥w</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <div class="decision-box">
                                <strong>ICR = 500 √∑ Dobowa dawka insuliny</strong><br/>
                                Przyk≈Çad: 20 j.i./dobƒô ‚Üí 500 √∑ 20 = 25 (1 j.i. na 25g WW)
                            </div>
                            <div class="decision-box">
                                <strong>ISF = 1800 √∑ Dobowa dawka insuliny</strong><br/>
                                Przyk≈Çad: 20 j.i./dobƒô ‚Üí 1800 √∑ 20 = 90 (1 j.i. zni≈ºa o 90 mg/dl)
                            </div>
                            <div class="warning-box">
                                ‚ö†Ô∏è To punkty startowe! Dostosuj na podstawie obserwacji!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- O PORADNIKU -->
                <div class="guide-section">
                    <div class="guide-header">
                        <span>‚ÑπÔ∏è O Poradniku</span>
                        <span class="guide-arrow">‚ñº</span>
                    </div>
                    <div class="guide-content">
                        <div class="guide-body">
                            <p><strong>Wersja: 2.3 - Kompletny plik z kodem wbudowanym</strong></p>
                            <p style="margin-top: 12px; font-size: 12px;">Poradnik wspomaga decyzje, ale NIGDY nie zastƒôpuje porad lekarza. ZAWSZE konsultuj z diabetologiem Aleksandra.</p>
                            <p style="margin-top: 12px; font-size: 12px;">üí™‚ù§Ô∏è ≈ªyczƒô si≈Çy i wielu szczƒô≈õliwych dni razem!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // COMPLETE EMBEDDED CODE FROM APP.JS + INTEGRATION
        let db = null;
        const DB_NAME = 'AlexanderDiabetesDB';
        const DB_VERSION = 1;

        const AppState = {
            products: [],
            categories: ['Piekarnicze', 'Owoce', 'Warzywa', 'Mleko', 'Miƒôso', 'S≈Çodyczne', 'Napoje', 'Inne'],
            selectedProducts: [],
            bolusHistory: [],
            parameters: {
                targetGlucose: 100,
                icr: 12,
                isf: 50
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDatabase();
            await loadDataFromDB();
            initializeTabs();
            initializeCalculator();
            initializeProducts();
            initializeGuide();
            
            if (AppState.products.length === 0) {
                loadSampleData();
                await saveAllData();
            }
        });

        // Database functions
        function initializeDatabase() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => resolve();
                request.onsuccess = () => {
                    db = request.result;
                    resolve();
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('products')) {
                        const store = db.createObjectStore('products', { keyPath: 'id' });
                        store.createIndex('category', 'category', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('bolusHistory')) {
                        db.createObjectStore('bolusHistory', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        async function loadDataFromDB() {
            if (!db) return;
            try {
                const products = await getFromDB('products');
                if (products.length > 0) AppState.products = products;
                const history = await getFromDB('bolusHistory');
                if (history.length > 0) AppState.bolusHistory = history;
            } catch (e) { console.error(e); }
        }

        function getFromDB(storeName) {
            return new Promise((resolve) => {
                if (!db) { resolve([]); return; }
                const tx = db.transaction([storeName], 'readonly');
                const store = tx.objectStore(storeName);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            });
        }

        function saveToDB(storeName, data) {
            return new Promise((resolve) => {
                if (!db) { resolve(); return; }
                const tx = db.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                store.put(data);
                tx.oncomplete = () => resolve();
            });
        }

        async function saveAllData() {
            if (!db) return;
            for (const p of AppState.products) {
                await saveToDB('products', p);
            }
            for (const h of AppState.bolusHistory) {
                await saveToDB('bolusHistory', h);
            }
        }

        function generateId() {
            return Date.now() + Math.random().toString(36).substr(2, 9);
        }

        function loadSampleData() {
            AppState.products = [
                { id: 1, name: 'Chleb pszenny', category: 'Piekarnicze', carbs: 49, unit: 'g', dateAdded: Date.now() },
                { id: 2, name: 'Banany', category: 'Owoce', carbs: 23.5, unit: 'g', dateAdded: Date.now() },
                { id: 3, name: 'Mleko 3.2%', category: 'Mleko', carbs: 4.8, unit: 'ml', dateAdded: Date.now() },
                { id: 4, name: 'Ry≈º bia≈Çy', category: 'Piekarnicze', carbs: 28, unit: 'g', dateAdded: Date.now() },
                { id: 5, name: 'Jab≈Çka', category: 'Owoce', carbs: 13.8, unit: 'g', dateAdded: Date.now() }
            ];
        }

        // Tab navigation
        function initializeTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });
        }

        // Calculator
        let pendingBolus = null;

        function initializeCalculator() {
            document.getElementById('calculate-bolus').addEventListener('click', calculateBolus);
            document.getElementById('add-product-btn').addEventListener('click', openProductModal);
            document.getElementById('confirm-bolus').addEventListener('click', confirmBolus);
            document.getElementById('cancel-bolus').addEventListener('click', () => {
                document.getElementById('bolus-result').style.display = 'none';
            });
            renderBolusHistory();
        }

        function calculateBolus() {
            const glucose = parseFloat(document.getElementById('glucose-level').value);
            const target = parseFloat(document.getElementById('target-glucose').value);
            const icr = parseFloat(document.getElementById('icr').value);
            const isf = parseFloat(document.getElementById('isf').value);
            const manual = parseFloat(document.getElementById('manual-carbs').value) || 0;

            if (!glucose) {
                alert('Podaj glikemiƒô!');
                return;
            }

            let totalCarbs = manual;
            AppState.selectedProducts.forEach(item => {
                const p = AppState.products.find(x => x.id === item.productId);
                if (p) totalCarbs += (item.quantity / 100) * p.carbs;
            });

            const mealBolus = totalCarbs / icr;
            const corrBolus = (glucose - target) / isf;
            const totalBolus = Math.max(0, mealBolus + corrBolus);

            pendingBolus = {
                timestamp: new Date(),
                glucose: glucose,
                carbs: totalCarbs,
                totalBolus: totalBolus,
                mealBolus: mealBolus,
                correctionBolus: corrBolus
            };

            document.getElementById('meal-bolus').textContent = mealBolus.toFixed(2);
            document.getElementById('correction-bolus').textContent = corrBolus.toFixed(2);
            document.getElementById('total-bolus').textContent = totalBolus.toFixed(2);
            document.getElementById('total-carbs').textContent = totalCarbs.toFixed(1);
            document.getElementById('bolus-result').style.display = 'block';
        }

        async function confirmBolus() {
            if (!pendingBolus) return;
            pendingBolus.id = generateId();
            AppState.bolusHistory.unshift(pendingBolus);
            if (AppState.bolusHistory.length > 20) {
                AppState.bolusHistory = AppState.bolusHistory.slice(0, 20);
            }
            await saveToDB('bolusHistory', pendingBolus);
            renderBolusHistory();
            document.getElementById('bolus-result').style.display = 'none';
            document.getElementById('glucose-level').value = '';
            document.getElementById('manual-carbs').value = '0';
            AppState.selectedProducts = [];
            renderSelectedProducts();
            alert('‚úì Bolus zapisany!');
        }

        function openProductModal() {
            const list = AppState.products.map(p => `${p.name} (${p.carbs}g WW/100)`).join('\n');
            const selected = prompt('Dostƒôpne produkty:\n\n' + list + '\n\nWpisz nazwƒô produktu:');
            if (selected) {
                const product = AppState.products.find(p => p.name.toLowerCase().includes(selected.toLowerCase()));
                if (product) {
                    const qty = prompt(`Ilo≈õƒá ${product.name} (w ${product.unit}):`);
                    if (qty) {
                        AppState.selectedProducts.push({
                            productId: product.id,
                            quantity: parseFloat(qty)
                        });
                        renderSelectedProducts();
                    }
                }
            }
        }

        function renderSelectedProducts() {
            const container = document.getElementById('selected-products');
            if (AppState.selectedProducts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Brak wybranych produkt√≥w</div>';
                document.getElementById('products-carbs').value = '0 g';
                return;
            }

            let html = '';
            let totalCarbs = 0;

            AppState.selectedProducts.forEach((item, idx) => {
                const p = AppState.products.find(x => x.id === item.productId);
                if (!p) return;
                const carbs = (item.quantity / 100) * p.carbs;
                totalCarbs += carbs;
                html += `
                    <div class="product-item">
                        <div class="product-info">${p.name} (${item.quantity} ${p.unit})</div>
                        <div class="product-carbs">${carbs.toFixed(1)}g</div>
                        <button class="remove-btn" onclick="removeProduct(${idx})">Usu≈Ñ</button>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('products-carbs').value = totalCarbs.toFixed(1) + ' g';
        }

        function removeProduct(idx) {
            AppState.selectedProducts.splice(idx, 1);
            renderSelectedProducts();
        }

        function renderBolusHistory() {
            const container = document.getElementById('bolus-history');
            if (AppState.bolusHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Brak historii</div>';
                return;
            }

            container.innerHTML = AppState.bolusHistory.map((h, i) => `
                <div style="background: #f8f9fb; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                    <div><strong>${new Date(h.timestamp).toLocaleString('pl-PL')}</strong></div>
                    <div>Glikemia: ${h.glucose} mg/dl | WW: ${h.carbs.toFixed(1)}g | Bolus: ${h.totalBolus.toFixed(2)} j.i.</div>
                </div>
            `).join('');
        }

        // Products tab
        function initializeProducts() {
            document.getElementById('search-products').addEventListener('keyup', renderProductsList);
            document.getElementById('filter-category').addEventListener('change', renderProductsList);
            populateCategories();
            renderProductsList();
        }

        function populateCategories() {
            const select = document.getElementById('filter-category');
            AppState.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                select.appendChild(opt);
            });
        }

        function renderProductsList() {
            const search = document.getElementById('search-products').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            let filtered = AppState.products;

            if (search) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(search));
            }
            if (category) {
                filtered = filtered.filter(p => p.category === category);
            }

            const container = document.getElementById('products-list');
            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Nie znaleziono produkt√≥w</div>';
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="product-item" style="cursor: pointer;" onclick="selectProductForCalculator(${p.id})">
                    <div class="product-info">${p.name}<br/><small>${p.category} | ${p.carbs}g WW/100</small></div>
                    <div class="product-carbs">${p.carbs}g</div>
                </div>
            `).join('');
        }

        function selectProductForCalculator(productId) {
            const p = AppState.products.find(x => x.id === productId);
            const qty = prompt(`Ilo≈õƒá ${p.name} (w ${p.unit}):`);
            if (qty) {
                AppState.selectedProducts.push({ productId: p.id, quantity: parseFloat(qty) });
                renderSelectedProducts();
            }
        }

        function addNewProduct() {
            const name = prompt('Nazwa produktu:');
            if (!name) return;
            const carbs = prompt('Wƒôglowodany na 100 j.m. (g):');
            if (!carbs) return;
            const category = prompt('Kategoria:', 'Inne');

            const product = {
                id: generateId(),
                name: name,
                category: category || 'Inne',
                carbs: parseFloat(carbs),
                unit: 'g',
                dateAdded: Date.now()
            };

            AppState.products.push(product);
            saveToDB('products', product);
            renderProductsList();
            alert('‚úì Produkt dodany!');
        }

        // Guide tab
        function initializeGuide() {
            document.querySelectorAll('.guide-header').forEach(header => {
                header.addEventListener('click', () => {
                    const section = header.closest('.guide-section');
                    section.classList.toggle('expanded');
                });
            });
        }
    </script>
</body>
</html>
