<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kalkulacja WW">
    <title>Kalkulator Wƒôglowodan√≥w - Aleksander</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        html, body, input, textarea, select {
            -webkit-user-scalable: no;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        input[type="text"], input[type="number"], textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #ffffff;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 16px env(safe-area-inset-top);
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .app-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .app-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .tabs-container {
            display: flex;
            gap: 0;
            background: #f8f9fb;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            overflow-x: auto;
            scroll-behavior: smooth;
        }

        .tab-button {
            flex: 1;
            min-width: 70px;
            padding: 10px 6px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f0f2ff;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .tab-content {
            display: none;
            padding: 16px;
            min-height: 100%;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* KALKULATOR */
        .calculator-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .meal-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .meal-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .meal-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .meal-details {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .meal-carbs {
            font-weight: 700;
            font-size: 16px;
            color: #667eea;
            text-align: right;
            margin-right: 8px;
        }

        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .add-meal-section {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
        }

        .add-meal-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .bolus-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .bolus-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .required {
            color: #ff6b6b;
            font-size: 16px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="number"], input[type="text"], select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="number"] {
            text-align: right;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .qty-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .bolus-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-top: 12px;
        }

        .bolus-result-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        /* PRODUKTY */
        .products-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .search-box {
            flex: 1;
        }

        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-dropdown, .sort-dropdown {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
            background: white;
        }

        .products-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-details {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .product-info {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .product-carbs {
            font-weight: 700;
            font-size: 14px;
            color: #667eea;
            text-align: right;
            margin-right: 12px;
        }

        .product-actions {
            display: flex;
            gap: 6px;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
        }

        .edit-btn {
            color: #667eea;
        }

        .delete-btn {
            color: #ff6b6b;
        }

        .add-product-section {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
        }

        .add-product-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        /* SKANER */
        .scanner-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #qr-reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #667eea;
        }

        .scanner-controls {
            display: flex;
            gap: 8px;
        }

        .scanner-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .start-scanner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stop-scanner {
            background: #ff6b6b;
            color: white;
        }

        .result-display {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            display: none;
        }

        .result-display.active {
            display: block;
        }

        .camera-info {
            background: #f0f2ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }

        /* PORADNIK */
        .guide-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .guide-category {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 14px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .category-arrow {
            font-size: 14px;
            transition: transform 0.3s;
        }

        .guide-category.expanded .category-arrow {
            transform: rotate(180deg);
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .guide-category.expanded .category-content {
            max-height: 3000px;
        }

        .content-body {
            padding: 14px;
            font-size: 13px;
            line-height: 1.6;
            color: #333;
        }

        .decision-tree {
            background: #f8f9fb;
            border-left: 3px solid #667eea;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
        }

        .condition {
            font-weight: 600;
            color: #667eea;
            margin: 8px 0 4px 0;
        }

        .action {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            border-left: 2px solid #28a745;
        }

        .warning {
            background: #fff3cd;
            border-left: 2px solid #ffc107;
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
        }

        .danger {
            background: #f8d7da;
            border-left: 2px solid #dc3545;
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .contact-box {
            background: #e7f3ff;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            font-size: 12px;
        }

        .contact-box strong {
            display: block;
            margin-bottom: 4px;
            color: #667eea;
        }

        .cheatsheet {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            font-size: 12px;
        }

        .cheatsheet-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .cheatsheet-row:last-child {
            border-bottom: none;
        }

        .cheatsheet-key {
            font-weight: 600;
            color: #667eea;
        }

        .cheatsheet-value {
            text-align: right;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: flex-end;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 100%;
            border-radius: 20px 20px 0 0;
            padding: 24px 16px 16px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-primary {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>üíâ Kalkulator WW</h1>
            <p>Aleksander | Cukrzyca Typ 1</p>
        </div>

        <div class="tabs-container">
            <button class="tab-button active" data-tab="calculator">Kalkulator</button>
            <button class="tab-button" data-tab="products">Produkty</button>
            <button class="tab-button" data-tab="scanner">Skaner</button>
            <button class="tab-button" data-tab="guide">üìñ Poradnik</button>
        </div>

        <div class="content-area">
            <!-- KALKULATOR -->
            <div class="tab-content active" id="calculator">
                <div class="calculator-section">
                    <div class="add-meal-section">
                        <button class="add-meal-btn" onclick="openAddMealModal()">+ Dodaj Posi≈Çek</button>
                    </div>
                    <div id="meals-list"></div>
                    <div class="summary-box">
                        <div class="summary-row">
                            <span>Razem wƒôglowodan√≥w:</span>
                            <span id="total-carbs">0 g</span>
                        </div>
                        <div class="summary-row">
                            <span>Ca≈Çkowita energia:</span>
                            <span id="total-calories">0 kcal</span>
                        </div>
                    </div>
                    <div class="bolus-section">
                        <div class="bolus-title">‚öôÔ∏è Kalkulator Bolusa</div>
                        <div class="input-group">
                            <label class="input-label">Carb Ratio <span class="required">*</span></label>
                            <input type="number" id="carb-ratio" placeholder="np. 12" step="0.5" inputmode="decimal" value="12">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Obecna glukoza <span class="required">*</span></label>
                            <input type="number" id="current-glucose" placeholder="np. 100" step="1" inputmode="numeric" value="100">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Cel glukozy <span class="required">*</span></label>
                            <input type="number" id="target-glucose" placeholder="np. 120" step="1" inputmode="numeric" value="120">
                        </div>
                        <div class="input-group">
                            <label class="input-label">ISF <span class="required">*</span></label>
                            <input type="number" id="isf" placeholder="np. 50" step="1" inputmode="numeric" value="50">
                        </div>
                        <div id="bolus-result" class="bolus-result" style="display: none;">
                            <div class="bolus-result-value" id="bolus-value">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">jednostek insuliny</div>
                        </div>
                        <button class="btn-primary" style="margin-top: 12px;" onclick="calculateBolus()">Oblicz Bolus</button>
                    </div>
                </div>
            </div>

            <!-- PRODUKTY -->
            <div class="tab-content" id="products">
                <div class="products-header">
                    <div class="search-box">
                        <input type="text" id="search-products" placeholder="Szukaj..." onkeyup="filterProducts()">
                    </div>
                    <select id="category-filter" class="filter-dropdown" onchange="filterProducts()">
                        <option value="">Wszystkie</option>
                    </select>
                    <select id="sort-products" class="sort-dropdown" onchange="sortProducts()">
                        <option value="date-desc">Najnowsze</option>
                        <option value="name-asc">A-Z</option>
                    </select>
                </div>
                <div class="add-product-section">
                    <button class="add-product-btn" onclick="openAddProductModal()">+ Dodaj Produkt</button>
                </div>
                <div id="products-list" class="products-list"></div>
            </div>

            <!-- SKANER -->
            <div class="tab-content" id="scanner">
                <div class="scanner-section">
                    <div id="camera-info" class="camera-info" style="display: none;"></div>
                    <div id="qr-reader"></div>
                    <div class="scanner-controls">
                        <button class="scanner-btn start-scanner" onclick="startScanner()">üì± Skanuj Kod</button>
                        <button class="scanner-btn stop-scanner" onclick="stopScanner()" style="display: none;" id="stop-scanner-btn">üõë Zatrzymaj</button>
                    </div>
                    <div id="scanner-result" class="result-display">
                        <div style="margin-bottom: 12px;">
                            <label class="form-label">Kod EAN</label>
                            <input type="text" id="scanned-code" class="form-input" readonly>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label class="form-label">Nazwa <span class="required">*</span></label>
                            <input type="text" id="scanned-name" class="form-input">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label class="form-label">Wƒôglowodany <span class="required">*</span></label>
                            <input type="number" id="scanned-carbs" class="form-input" inputmode="numeric" step="0.1">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label class="form-label">Kategoria <span class="required">*</span></label>
                            <select id="scanned-category" class="form-input"></select>
                        </div>
                        <div class="form-actions">
                            <button class="btn-primary" onclick="saveScannedProduct()">Zapisz</button>
                            <button class="btn-secondary" onclick="closeScannedProduct()">Anuluj</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PORADNIK -->
            <div class="tab-content" id="guide">
                <div class="guide-section" id="guide-content"></div>
            </div>
        </div>
    </div>

    <!-- MODAL - Dodaj Posi≈Çek -->
    <div class="modal" id="add-meal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Dodaj Posi≈Çek</span>
                <button class="close-btn" onclick="closeAddMealModal()">‚úï</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">Produkt <span class="required">*</span></label>
                    <select id="meal-product-select" class="form-input" onchange="updateProductDetails()"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ilo≈õƒá <span class="required">*</span></label>
                    <div class="input-wrapper">
                        <button class="qty-btn" onclick="decrementQty()">‚àí</button>
                        <input type="number" id="meal-quantity" class="form-input" placeholder="0" inputmode="numeric" value="100" style="text-align: center;">
                        <button class="qty-btn" onclick="incrementQty()">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Wƒôglowodany (wyliczone)</label>
                    <div style="font-size: 16px; font-weight: 700; color: #667eea; padding: 10px; background: #f0f2ff; border-radius: 8px;" id="meal-carbs-preview">0 g</div>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveMeal()">Dodaj</button>
                    <button class="btn-secondary" onclick="closeAddMealModal()">Anuluj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL - Dodaj Produkt -->
    <div class="modal" id="add-product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Dodaj Produkt</span>
                <button class="close-btn" onclick="closeAddProductModal()">‚úï</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label class="form-label">Nazwa <span class="required">*</span></label>
                    <input type="text" id="product-name" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Jednostka <span class="required">*</span></label>
                    <select id="product-unit" class="form-input">
                        <option value="g">gramy (g)</option>
                        <option value="ml">mililitry (ml)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Wƒôglowodany /100j <span class="required">*</span></label>
                    <input type="number" id="product-carbs" class="form-input" inputmode="decimal" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">Kategoria <span class="required">*</span></label>
                    <select id="product-category" class="form-input"></select>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="saveProduct()">Zapisz</button>
                    <button class="btn-secondary" onclick="closeAddProductModal()">Anuluj</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <script>
        const DEFAULT_CATEGORIES = ['Owoce', 'Warzywa', 'Zbo≈ºa i Chleb', 'Nabia≈Ç', 'Miƒôso i Dr√≥b', 'Ryby', 'Leguminy', 'T≈Çuszcze', 'Napoje', 'Desery', 'Inne'];
        const DEFAULT_PRODUCTS = [
            {id: 1, name: 'Chleb pszenny', unit: 'g', carbs: 49, category: 'Zbo≈ºa i Chleb', timestamp: Date.now()},
            {id: 2, name: 'Banany', unit: 'g', carbs: 23.5, category: 'Owoce', timestamp: Date.now()},
            {id: 3, name: 'Mleko', unit: 'ml', carbs: 4.8, category: 'Nabia≈Ç', timestamp: Date.now()},
            {id: 4, name: 'Ry≈º gotowany', unit: 'g', carbs: 28, category: 'Zbo≈ºa i Chleb', timestamp: Date.now()},
            {id: 5, name: 'Jab≈Çka', unit: 'g', carbs: 13.8, category: 'Owoce', timestamp: Date.now()}
        ];

        let meals = [];
        let currentEditProductId = null;
        let html5QrcodeScanner = null;

        function loadData() {
            window.categories = JSON.parse(localStorage.getItem('categories') || JSON.stringify(DEFAULT_CATEGORIES));
            window.products = JSON.parse(localStorage.getItem('products') || JSON.stringify(DEFAULT_PRODUCTS));
            meals = JSON.parse(localStorage.getItem('meals') || '[]');
            window.cameraPrefs = JSON.parse(localStorage.getItem('cameraPrefs') || '{}');
            updateCategorySelects();
            renderMeals();
            renderProducts();
            initializeGuide();
        }

        function saveData() {
            localStorage.setItem('categories', JSON.stringify(window.categories));
            localStorage.setItem('products', JSON.stringify(window.products));
            localStorage.setItem('meals', JSON.stringify(meals));
            localStorage.setItem('cameraPrefs', JSON.stringify(window.cameraPrefs));
        }

        // TAB SWITCHING
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // MEALS
        function renderMeals() {
            const container = document.getElementById('meals-list');
            if (meals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üçΩÔ∏è</div><div>Brak posi≈Çk√≥w</div></div>';
            } else {
                container.innerHTML = meals.map((m, i) => `
                    <div class="meal-item">
                        <div class="meal-info">
                            <div class="meal-name">${m.product.name}</div>
                            <div class="meal-details">${m.quantity} ${m.product.unit}</div>
                        </div>
                        <div class="meal-carbs">${m.carbs.toFixed(1)}g</div>
                        <button class="remove-btn" onclick="removeMeal(${i})">Usu≈Ñ</button>
                    </div>
                `).join('');
            }
            updateSummary();
        }

        function updateSummary() {
            const totalCarbs = meals.reduce((s, m) => s + m.carbs, 0);
            const totalCal = meals.reduce((s, m) => s + ((m.quantity/100) * (m.product.calories || 0)), 0);
            document.getElementById('total-carbs').textContent = totalCarbs.toFixed(1) + ' g';
            document.getElementById('total-calories').textContent = Math.round(totalCal) + ' kcal';
        }

        function openAddMealModal() {
            if (!window.products.length) {
                showAlert('Brak produkt√≥w!', 'error');
                return;
            }
            const sel = document.getElementById('meal-product-select');
            sel.innerHTML = window.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            updateProductDetails();
            document.getElementById('add-meal-modal').classList.add('active');
        }

        function closeAddMealModal() {
            document.getElementById('add-meal-modal').classList.remove('active');
        }

        function updateProductDetails() {
            const id = parseInt(document.getElementById('meal-product-select').value);
            const p = window.products.find(x => x.id === id);
            if (!p) return;
            const qty = parseInt(document.getElementById('meal-quantity').value) || 100;
            const carbs = (qty/100) * p.carbs;
            document.getElementById('meal-carbs-preview').textContent = carbs.toFixed(1) + ' g';
        }

        function incrementQty() {
            const inp = document.getElementById('meal-quantity');
            inp.value = (parseInt(inp.value) || 0) + 10;
            updateProductDetails();
        }

        function decrementQty() {
            const inp = document.getElementById('meal-quantity');
            inp.value = Math.max(1, (parseInt(inp.value) || 0) - 10);
            updateProductDetails();
        }

        function saveMeal() {
            const id = parseInt(document.getElementById('meal-product-select').value);
            const p = window.products.find(x => x.id === id);
            const qty = parseInt(document.getElementById('meal-quantity').value);
            if (!p || !qty) return;
            const carbs = (qty/100) * p.carbs;
            const cal = (qty/100) * (p.calories || 0);
            meals.push({product: p, quantity: qty, carbs, calories: cal});
            saveData();
            renderMeals();
            closeAddMealModal();
            showAlert('Posi≈Çek dodany!', 'success');
        }

        function removeMeal(idx) {
            meals.splice(idx, 1);
            saveData();
            renderMeals();
        }

        function calculateBolus() {
            const carbs = meals.reduce((s, m) => s + m.carbs, 0);
            const ratio = parseFloat(document.getElementById('carb-ratio').value) || 12;
            const gluc = parseFloat(document.getElementById('current-glucose').value) || 100;
            const target = parseFloat(document.getElementById('target-glucose').value) || 120;
            const isf = parseFloat(document.getElementById('isf').value) || 50;
            const bolus = Math.max(0, (carbs/ratio) + (gluc-target)/isf);
            document.getElementById('bolus-result').style.display = 'block';
            document.getElementById('bolus-value').textContent = bolus.toFixed(1);
        }

        // PRODUCTS
        function renderProducts() {
            const container = document.getElementById('products-list');
            const search = document.getElementById('search-products').value.toLowerCase();
            const cat = document.getElementById('category-filter').value;
            let list = window.products.filter(p => 
                p.name.toLowerCase().includes(search) && 
                (!cat || p.category === cat)
            );
            const sort = document.getElementById('sort-products').value;
            if (sort === 'name-asc') list.sort((a,b) => a.name.localeCompare(b.name));
            if (sort === 'date-desc') list.sort((a,b) => (b.timestamp||0)-(a.timestamp||0));
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div>Brak produkt√≥w</div></div>';
            } else {
                container.innerHTML = list.map(p => `
                    <div class="product-card">
                        <div class="product-details">
                            <div class="product-name">${p.name}</div>
                            <div class="product-info">${p.category} ‚Ä¢ ${p.carbs}g/100</div>
                        </div>
                        <div class="product-carbs">${p.carbs}g</div>
                        <div class="product-actions">
                            <button class="edit-btn" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
                            <button class="delete-btn" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function filterProducts() {
            renderProducts();
        }

        function sortProducts() {
            renderProducts();
        }

        function updateCategorySelects() {
            ['product-category', 'scanned-category'].forEach(id => {
                const sel = document.getElementById(id);
                if (sel) sel.innerHTML = window.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            });
            document.getElementById('category-filter').innerHTML = '<option value="">Wszystkie</option>' + 
                window.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function openAddProductModal() {
            currentEditProductId = null;
            document.getElementById('product-name').value = '';
            document.getElementById('product-carbs').value = '';
            document.querySelector('#add-product-modal .modal-header span').textContent = 'Dodaj Produkt';
            document.getElementById('add-product-modal').classList.add('active');
        }

        function closeAddProductModal() {
            document.getElementById('add-product-modal').classList.remove('active');
        }

        function saveProduct() {
            const name = document.getElementById('product-name').value.trim();
            const unit = document.getElementById('product-unit').value;
            const carbs = parseFloat(document.getElementById('product-carbs').value);
            const cat = document.getElementById('product-category').value;
            if (!name || !carbs || !cat) return;
            if (currentEditProductId) {
                const p = window.products.find(x => x.id === currentEditProductId);
                p.name = name; p.unit = unit; p.carbs = carbs; p.category = cat; p.timestamp = Date.now();
            } else {
                window.products.push({id: Date.now(), name, unit, carbs, category: cat, timestamp: Date.now()});
            }
            saveData();
            renderProducts();
            closeAddProductModal();
            showAlert('Produkty zaktualizowane!', 'success');
        }

        function editProduct(id) {
            const p = window.products.find(x => x.id === id);
            if (!p) return;
            currentEditProductId = id;
            document.getElementById('product-name').value = p.name;
            document.getElementById('product-unit').value = p.unit;
            document.getElementById('product-carbs').value = p.carbs;
            document.getElementById('product-category').value = p.category;
            document.querySelector('#add-product-modal .modal-header span').textContent = 'Edytuj Produkt';
            document.getElementById('add-product-modal').classList.add('active');
        }

        function deleteProduct(id) {
            if (confirm('UsunƒÖƒá?')) {
                window.products = window.products.filter(p => p.id !== id);
                saveData();
                renderProducts();
                showAlert('Usuniƒôto!', 'success');
            }
        }

        // SCANNER
        function startScanner() {
            document.getElementById('qr-reader').innerHTML = '';
            document.querySelector('.start-scanner').style.display = 'none';
            document.getElementById('stop-scanner-btn').style.display = 'block';
            html5QrcodeScanner = new Html5QrcodeScanner('qr-reader', 
                {fps: 15, qrbox: {width: 250, height: 250}, facingMode: 'environment'}, false);
            html5QrcodeScanner.render(onScanSuccess, () => {});
            window.cameraPrefs.permissionGranted = true;
            saveData();
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }
            document.querySelector('.start-scanner').style.display = 'block';
            document.getElementById('stop-scanner-btn').style.display = 'none';
        }

        function onScanSuccess(code) {
            stopScanner();
            document.getElementById('scanned-code').value = code;
            document.getElementById('scanner-result').classList.add('active');
        }

        function closeScannedProduct() {
            document.getElementById('scanner-result').classList.remove('active');
        }

        function saveScannedProduct() {
            const name = document.getElementById('scanned-name').value.trim();
            const carbs = parseFloat(document.getElementById('scanned-carbs').value);
            const cat = document.getElementById('scanned-category').value;
            if (!name || isNaN(carbs) || !cat) return;
            window.products.push({
                id: Date.now(),
                name, carbs, category: cat, unit: 'g',
                timestamp: Date.now()
            });
            saveData();
            closeScannedProduct();
            renderProducts();
            showAlert('Produkt zapisany!', 'success');
        }

        // GUIDE
        function initializeGuide() {
            const content = document.getElementById('guide-content');
            content.innerHTML = `
                <div class="guide-category expanded">
                    <div class="category-header">
                        <span><span style="font-size: 16px; margin-right: 8px;">üìû</span>Kontakt Z Zespo≈Çem</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                    <div class="category-content">
                        <div class="content-body">
                            <div class="contact-box">
                                <strong>üö® POGOTOWIE</strong>
                                <strong style="color: red; font-size: 16px;">999</strong>
                            </div>
                            <div class="contact-box">
                                <strong>üë®‚Äç‚öïÔ∏è Lekarz Diabetolog (dzisiaj)</strong>
                                <small>Nr: _____________</small>
                            </div>
                            <div class="contact-box">
                                <strong>üè• Poradnia</strong>
                                <small>Nr: _____________</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-category">
                    <div class="category-header">
                        <span><span style="font-size: 16px; margin-right: 8px;">‚ö°</span>Szybka ≈öciƒÖga</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                    <div class="category-content">
                        <div class="content-body">
                            <div class="cheatsheet">
                                <div class="cheatsheet-row">
                                    <span class="cheatsheet-key">&lt;55 mg/dl</span>
                                    <span class="cheatsheet-value">üî¥ Hipoglikemia</span>
                                </div>
                                <div class="cheatsheet-row">
                                    <span class="cheatsheet-key">70-150 mg/dl</span>
                                    <span class="cheatsheet-value">üü¢ Norma</span>
                                </div>
                                <div class="cheatsheet-row">
                                    <span class="cheatsheet-key">&gt;250 mg/dl</span>
                                    <span class="cheatsheet-value">üî¥ Bardzo wysoka</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-category">
                    <div class="category-header">
                        <span><span style="font-size: 16px; margin-right: 8px;">üî¥</span>Niska Glukoza (&lt;70)</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                    <div class="category-content">
                        <div class="content-body">
                            <div class="decision-tree">
                                <div class="condition">‚ÑπÔ∏è Je≈õli Aleksander ma &lt;70 mg/dl:</div>
                                <div class="action">1Ô∏è‚É£ Zmierz ponownie</div>
                                <div class="action">2Ô∏è‚É£ Podaj szybkie WW (4-5g): sok, cukier</div>
                                <div class="action">3Ô∏è‚É£ Czekaj 15 minut</div>
                                <div class="action">4Ô∏è‚É£ Zmierz ponownie</div>
                            </div>
                            <div class="danger">üö® Je≈õli NIEPRZYTOMNY ‚Üí Wezwij 999!</div>
                        </div>
                    </div>
                </div>

                <div class="guide-category">
                    <div class="category-header">
                        <span><span style="font-size: 16px; margin-right: 8px;">ü§í</span>Infekcja / Choroba</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                    <div class="category-content">
                        <div class="content-body">
                            <div class="warning">‚ö†Ô∏è <strong>ZAWSZE podawaj insulinƒô!</strong> Nawet je≈õli nie je.</div>
                            <div class="action" style="margin-top: 8px;">‚Ä¢ Mierz glukozƒô co 2-4h</div>
                            <div class="action">‚Ä¢ Glukoza zwykle ro≈õnie</div>
                            <div class="action">‚Ä¢ Zwiƒôksz insulinƒô o 10-50%</div>
                            <div class="action">‚Ä¢ Monitoruj ketony (wa≈ºne!)</div>
                        </div>
                    </div>
                </div>

                <div class="guide-category">
                    <div class="category-header">
                        <span><span style="font-size: 16px; margin-right: 8px;">üìã</span>Podstawowe Zasady</span>
                        <span class="category-arrow">‚ñº</span>
                    </div>
                    <div class="category-content">
                        <div class="content-body">
                            <div class="action">1. <strong>ZAWSZE podawaj insulinƒô</strong></div>
                            <div class="action">2. Mierz glukozƒô regularnie</div>
                            <div class="action">3. Obserwuj zapotrzebowanie na insulinƒô</div>
                            <div class="action">4. Dieta = obliczanie wƒôglowodan√≥w</div>
                            <div class="action">5. Edukuj rodzinƒô</div>
                        </div>
                    </div>
                </div>
            `;

            document.querySelectorAll('.category-header').forEach(h => {
                h.addEventListener('click', function() {
                    this.closest('.guide-category').classList.toggle('expanded');
                });
            });
        }

        function showAlert(msg, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = msg;
            document.querySelector('.content-area').insertBefore(alert, document.querySelector('.tab-content.active').firstChild);
            setTimeout(() => alert.remove(), 3000);
        }

        loadData();
    </script>
</body>
</html>
