<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Węglowodanów - Aleksander</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.12);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.95;
            font-size: 13px;
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 24px;
            gap: 16px;
            overflow-x: auto;
        }

        .tab {
            flex: 0;
            padding: 14px 0;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            white-space: nowrap;
        }

        .tab:hover {
            color: #0066cc;
        }

        .tab.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }

        .content {
            padding: 24px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #1e293b;
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .section h3 {
            color: #1e293b;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            margin-top: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 12px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 102, 204, 0.25);
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-danger {
            background: #dc2626;
            padding: 6px 12px;
            font-size: 13px;
            width: auto;
            margin-top: 0;
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 13px;
            width: auto;
        }

        .summary {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .summary h2 {
            color: white;
            font-size: 14px;
            margin-bottom: 14px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-label {
            font-size: 11px;
            opacity: 0.85;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 6px;
        }

        .meal-item {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #0066cc;
        }

        .meal-item-info {
            flex: 1;
        }

        .meal-item-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }

        .meal-item-details {
            color: #64748b;
            font-size: 12px;
            margin-top: 3px;
        }

        .product-item {
            background: #f1f5f9;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-left: 3px solid #10b981;
        }

        .product-info {
            flex: 1;
        }

        .product-info h3 {
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .product-info p {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 2px;
        }

        .product-actions {
            display: flex;
            gap: 6px;
        }

        .form-section {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #1e293b;
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
        }

        .number-input-wrapper {
            display: flex;
            align-items: center;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .number-btn {
            background: #e2e8f0;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-weight: bold;
            color: #0066cc;
            flex-shrink: 0;
        }

        .number-btn:hover {
            background: #cbd5e1;
        }

        .number-input-wrapper input {
            flex: 1;
            border: none;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            padding: 10px;
        }

        #qr-reader {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .scanner-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .scanner-controls button {
            flex: 1;
            min-width: 100px;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #0066cc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #0c4a6e;
        }

        .success-box {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #065f46;
        }

        .error-box {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #7f1d1d;
        }

        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 32px 20px;
            color: #64748b;
        }

        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            background: #10b981;
            color: white;
            padding: 12px 18px;
            border-radius: 6px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .category-badge {
            display: inline-block;
            background: #dbeafe;
            color: #0066cc;
            padding: 3px 8px;
            border-radius: 14px;
            font-size: 11px;
            margin-left: 6px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-group .btn {
            flex: 1;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="container">
        <div class="header">
            <h1>Kalkulator Węglowodanów</h1>
            <p>Aleksander • Cukrzyca Typ 1</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'calculator')">Kalkulator</button>
            <button class="tab" onclick="switchTab(event, 'scanner')">Skaner</button>
            <button class="tab" onclick="switchTab(event, 'products')">Produkty</button>
        </div>

        <div class="content">
            <!-- Kalkulator -->
            <div id="calculator" class="section active">
                <h2>Aktualny Posiłek</h2>

                <div class="form-section">
                    <h3>Dodaj produkt</h3>
                    <div class="form-group">
                        <label>Produkt</label>
                        <select id="selectProduct">
                            <option value="">-- Wybierz --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ilość</label>
                        <div class="number-input-wrapper">
                            <button class="number-btn" onclick="decrementAmount()">−</button>
                            <input type="number" id="productAmount" inputmode="numeric" placeholder="0" min="1" value="100">
                            <button class="number-btn" onclick="incrementAmount()">+</button>
                        </div>
                    </div>
                    <button class="btn" onclick="addToMeal()">Dodaj do posiłku</button>
                </div>

                <h3>Produkty w posiłku</h3>
                <div id="mealList" class="empty-state">Brak produktów</div>

                <div class="summary">
                    <h2>Podsumowanie</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Węglowodany</div>
                            <div class="summary-value" id="totalCarbs">0.0g</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Wymienniki</div>
                            <div class="summary-value" id="totalWW">0.0WW</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="clearMeal()">Wyczyść posiłek</button>
            </div>

            <!-- Skaner -->
            <div id="scanner" class="section">
                <h2>Skaner kodów i etykiet</h2>

                <div class="info-box">
                    Skanuj kod kreskowy lub etykietę produktu
                </div>

                <div class="scanner-controls">
                    <button class="btn btn-success" onclick="startBarcodeScanner()">Kod kreskowy</button>
                    <button class="btn" onclick="startLabelScanner()">Skanuj etykietę</button>
                    <button class="btn btn-secondary" onclick="stopAllScanners()">Wyłącz</button>
                </div>

                <div id="qr-reader"></div>
                <div id="labelScannerContainer" style="display:none;">
                    <video id="labelVideo" style="width:100%; border-radius:8px; margin-bottom:12px; max-height:300px;"></video>
                    <button class="btn btn-success" onclick="captureLabel()">Zrób zdjęcie</button>
                </div>
                <canvas id="capturedCanvas" style="display:none;"></canvas>

                <div id="scannerStatus"></div>
                <div id="scannerResult"></div>
            </div>

            <!-- Produkty -->
            <div id="products" class="section">
                <div class="header-actions">
                    <h2>Moje Produkty</h2>
                    <button class="btn btn-small" onclick="showAddProductForm()">+ Dodaj</button>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Szukaj..." oninput="filterProducts()">
                </div>

                <div id="addProductForm" style="display: none;">
                    <div class="form-section">
                        <h3 id="formTitle">Dodaj produkt</h3>
                        <div class="form-group">
                            <label>Nazwa</label>
                            <input type="text" id="productName">
                        </div>
                        <div class="form-group">
                            <label>Kategoria</label>
                            <select id="productCategory">
                                <option value="inne">Inne</option>
                                <option value="pieczywo">Pieczywo</option>
                                <option value="owoce">Owoce</option>
                                <option value="nabiał">Nabiał</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Węglowodany na 100g</label>
                            <input type="number" id="productCarbs" min="0" step="0.1">
                        </div>
                        <div class="btn-group">
                            <button class="btn" onclick="saveProduct()">Zapisz</button>
                            <button class="btn btn-secondary" onclick="cancelProductForm()">Anuluj</button>
                        </div>
                    </div>
                </div>

                <div id="productList"></div>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let currentMeal = [];
        let editingProductId = null;
        let html5QrcodeScanner = null;
        let labelStream = null;

        function init() {
            loadProducts();
            loadMeal();
            updateMealDisplay();
            updateProductList();
            updateProductSelect();
        }

        function saveProductsToStorage() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function loadProducts() {
            const saved = localStorage.getItem('products');
            if (saved) {
                products = JSON.parse(saved);
            } else {
                products = [
                    {id: 1, name: "Chleb pszenny", category: "pieczywo", carbsPer100: 49},
                    {id: 2, name: "Banan", category: "owoce", carbsPer100: 23.5},
                    {id: 3, name: "Jogurt naturalny", category: "nabiał", carbsPer100: 4.7},
                    {id: 4, name: "Makaron ugotowany", category: "inne", carbsPer100: 30}
                ];
                saveProductsToStorage();
            }
        }

        function saveMealToStorage() {
            localStorage.setItem('currentMeal', JSON.stringify(currentMeal));
        }

        function loadMeal() {
            const saved = localStorage.getItem('currentMeal');
            if (saved) {
                currentMeal = JSON.parse(saved);
            }
        }

        function switchTab(evt, tabName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            evt.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName !== 'scanner') {
                stopAllScanners();
            }
        }

        function showNotification(msg, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.style.background = type === 'success' ? '#10b981' : '#dc2626';
            notif.style.display = 'block';
            setTimeout(() => { notif.style.display = 'none'; }, 2500);
        }

        function incrementAmount() {
            const inp = document.getElementById('productAmount');
            inp.value = (parseInt(inp.value) || 0) + 1;
        }

        function decrementAmount() {
            const inp = document.getElementById('productAmount');
            const val = parseInt(inp.value) || 1;
            if (val > 1) inp.value = val - 1;
        }

        function showAddProductForm() {
            document.getElementById('addProductForm').style.display = 'block';
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = 'inne';
            document.getElementById('productCarbs').value = '';
            editingProductId = null;
        }

        function cancelProductForm() {
            document.getElementById('addProductForm').style.display = 'none';
            editingProductId = null;
        }

        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const cat = document.getElementById('productCategory').value;
            const carbs = parseFloat(document.getElementById('productCarbs').value);

            if (!name || !carbs || carbs < 0) {
                showNotification('Wypełnij wszystkie pola!', 'error');
                return;
            }

            if (editingProductId) {
                const idx = products.findIndex(p => p.id === editingProductId);
                if (idx >= 0) {
                    products[idx] = {id: editingProductId, name, category: cat, carbsPer100: carbs};
                    showNotification('Produkt zaktualizowany!');
                }
            } else {
                products.push({id: Date.now(), name, category: cat, carbsPer100: carbs});
                showNotification('Produkt dodany!');
            }

            saveProductsToStorage();
            cancelProductForm();
            updateProductList();
            updateProductSelect();
        }

        function editProduct(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            document.getElementById('productName').value = p.name;
            document.getElementById('productCategory').value = p.category;
            document.getElementById('productCarbs').value = p.carbsPer100;
            document.getElementById('addProductForm').style.display = 'block';
            editingProductId = id;
        }

        function deleteProduct(id) {
            if (confirm('Usunąć produkt?')) {
                products = products.filter(p => p.id !== id);
                saveProductsToStorage();
                updateProductList();
                updateProductSelect();
                showNotification('Usunięto!');
            }
        }

        function updateProductList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(term) || p.category.toLowerCase().includes(term)
            );

            const html = filtered.length === 0
                ? '<div class="empty-state">Brak produktów</div>'
                : filtered.map(p => `
                    <div class="product-item">
                        <div class="product-info">
                            <h3>${p.name}<span class="category-badge">${p.category}</span></h3>
                            <p>${p.carbsPer100}g na 100g</p>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-small" onclick="editProduct(${p.id})">Edytuj</button>
                            <button class="btn btn-danger" onclick="deleteProduct(${p.id})">Usuń</button>
                        </div>
                    </div>
                `).join('');

            document.getElementById('productList').innerHTML = html;
        }

        function filterProducts() {
            updateProductList();
        }

        function updateProductSelect() {
            const sel = document.getElementById('selectProduct');
            sel.innerHTML = '<option value="">-- Wybierz --</option>' +
                products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function addToMeal() {
            const pid = parseInt(document.getElementById('selectProduct').value);
            const amt = parseFloat(document.getElementById('productAmount').value);

            if (!pid || !amt || amt <= 0) {
                showNotification('Wybierz produkt i ilość!', 'error');
                return;
            }

            const prod = products.find(p => p.id === pid);
            if (!prod) return;

            const carbs = (amt * prod.carbsPer100) / 100;
            currentMeal.push({
                id: Date.now(),
                productId: pid,
                productName: prod.name,
                amount: amt,
                carbs: carbs
            });

            saveMealToStorage();
            updateMealDisplay();
            document.getElementById('selectProduct').value = '';
            document.getElementById('productAmount').value = '100';
            showNotification('Dodano!');
        }

        function removeFromMeal(id) {
            currentMeal = currentMeal.filter(item => item.id !== id);
            saveMealToStorage();
            updateMealDisplay();
            showNotification('Usunięto!');
        }

        function updateMealDisplay() {
            const total = currentMeal.reduce((s, i) => s + i.carbs, 0);
            const ww = total / 10;

            document.getElementById('totalCarbs').textContent = total.toFixed(1) + 'g';
            document.getElementById('totalWW').textContent = ww.toFixed(1) + 'WW';

            const html = currentMeal.length === 0
                ? '<div class="empty-state">Brak produktów</div>'
                : currentMeal.map(item => `
                    <div class="meal-item">
                        <div class="meal-item-info">
                            <div class="meal-item-name">${item.productName}</div>
                            <div class="meal-item-details">${item.amount}g • ${item.carbs.toFixed(1)}g w/w</div>
                        </div>
                        <button class="btn btn-danger" onclick="removeFromMeal(${item.id})">Usuń</button>
                    </div>
                `).join('');

            document.getElementById('mealList').innerHTML = html;
        }

        function clearMeal() {
            if (confirm('Wyczyścić posiłek?')) {
                currentMeal = [];
                saveMealToStorage();
                updateMealDisplay();
                showNotification('Wyczyszczono!');
            }
        }

        // SKANER KODÓW
        function startBarcodeScanner() {
            stopAllScanners();
            const reader = document.getElementById('qr-reader');
            reader.style.display = 'block';

            html5QrcodeScanner = new Html5QrcodeScanner(
                'qr-reader',
                { fps: 10, qrbox: { width: 250, height: 250 } },
                false
            );

            html5QrcodeScanner.render(onBarcodeSuccess, onError);
            document.getElementById('scannerStatus').innerHTML = '<div class="info-box">Kamera aktywna - skieruj kod kreskowy</div>';
        }

        function onBarcodeSuccess(txt) {
            const ean = txt.trim();
            document.getElementById('scannerResult').innerHTML = '<div class="success-box">Odczytano: ' + ean + '<br><button class="btn btn-success" style="margin-top:10px;" onclick="testAddProduct()">Dodaj testowo</button></div>';
        }

        function testAddProduct() {
            const newProd = {
                id: Date.now(),
                name: 'Produkt skanowany',
                category: 'inne',
                carbsPer100: 25
            };
            products.push(newProd);
            saveProductsToStorage();
            updateProductSelect();
            showNotification('Test: Produkt dodany!');
        }

        function onError(e) {
            // Silent error handling
        }

        // SKANER ETYKIET
        async function startLabelScanner() {
            stopAllScanners();
            const container = document.getElementById('labelScannerContainer');
            container.style.display = 'block';

            try {
                labelStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                const video = document.getElementById('labelVideo');
                video.srcObject = labelStream;
                video.play();
                document.getElementById('scannerStatus').innerHTML = '<div class="info-box">Kamera etykiety aktywna</div>';
            } catch (e) {
                document.getElementById('scannerStatus').innerHTML = '<div class="error-box">Brak dostępu do kamery</div>';
            }
        }

        async function captureLabel() {
            const video = document.getElementById('labelVideo');
            const canvas = document.getElementById('capturedCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            document.getElementById('scannerStatus').innerHTML = '<div class="info-box">Przetwarzanie OCR...</div>';

            try {
                const result = await Tesseract.recognize(canvas.toDataURL(), 'pol+eng');
                const text = result.data.text;

                document.getElementById('scannerResult').innerHTML = '<div class="success-box"><strong>Wynik OCR:</strong><br>' + text.substring(0, 200) + '...<br><button class="btn btn-success" style="margin-top:10px;" onclick="testAddFromOCR()">Dodaj testowo</button></div>';
            } catch (e) {
                document.getElementById('scannerStatus').innerHTML = '<div class="error-box">Błąd OCR: ' + e.message + '</div>';
            }
        }

        function testAddFromOCR() {
            const newProd = {
                id: Date.now(),
                name: 'Z etykiety (test)',
                category: 'inne',
                carbsPer100: 30
            };
            products.push(newProd);
            saveProductsToStorage();
            updateProductSelect();
            showNotification('Test: Produkt z OCR dodany!');
        }

        function stopAllScanners() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
                document.getElementById('qr-reader').style.display = 'none';
            }
            if (labelStream) {
                labelStream.getTracks().forEach(t => t.stop());
                labelStream = null;
                document.getElementById('labelScannerContainer').style.display = 'none';
            }
            document.getElementById('scannerStatus').innerHTML = '';
        }

        window.onload = init;
    </script>
</body>
</html>
